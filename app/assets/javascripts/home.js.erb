$(document).ready(function(){
  renderBoard();
  renderPieces();
  choosePieceListener();
});


function renderBoard(){
  $.makeArray($(".row")).forEach(function(row, y){
    $(row).html(renderRow(row, y));
  });
}

function renderRow(row, y){
  var html = "";
  if($(row).hasClass('even')){
    for(var i=0; i<4; i++){
      html = html + new Square("off", 2 * i, y).render() + new Square("on", 2 * i + 1, y).render();
    }
  } else if($(row).hasClass('odd')){
    for(var i=0; i<4; i++){
      html = html + new Square("on", 2 * i, y).render() + new Square("off", 2 * i + 1, y).render();
    }
  }
  return html;
}

function renderPieces(){
  $.makeArray($('.p2-start > .on')).forEach(function(square, index){
    new Piece('p2').goToSquare(Square.findByPosition($(square).attr('x'), $(square).attr('y')));
  })
  $.makeArray($('.p1-start > .on')).forEach(function(square, index){
    new Piece('p1').goToSquare(Square.findByPosition($(square).attr('x'), $(square).attr('y')));
  })
}

function choosePieceListener(){
  $('.piece').on('click', function(e){
    e.stopPropagation();
    $('.piece').off();

    if ($(".selected").length == 0){
      var piece = Piece.findOnClick(this);
      piece.toggleHighlight();
      $(this).parent().toggleClass("selected");
    }
    squareChoiceListener(piece);
  });
}

function squareChoiceListener(piece){
  $('.on').on('click', piece, function(e){
    var piece = e.data;
    e.stopPropagation();
    $('.on').off();
    if($(this).hasClass('selected')){
      piece.toggleHighlight();
      $(this).toggleClass('selected');
      choosePieceListener();
    } else if ($(this).hasClass("highlighted")){
      piece.move(Square.findByJSquare($(this)));
      $('.selected').toggleClass('selected');
    } else if ($(this).hasClass("on")){
      squareChoiceListener(piece);
    }
  });
}

function getPosition(square){
  return square.attr('position').split(',').map(Number);
}
